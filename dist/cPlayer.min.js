!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define("cPlayer",[],t):"object"==typeof exports?exports.cPlayer=t():e.cPlayer=t()}(this,function(){return function(e){function t(l){if(n[l])return n[l].exports;var r=n[l]={i:l,l:!1,exports:{}};return e[l].call(r.exports,r,r.exports,t),r.l=!0,r.exports}var n={};return t.m=e,t.c=n,t.d=function(e,n,l){t.o(e,n)||Object.defineProperty(e,n,{configurable:!1,enumerable:!0,get:l})},t.n=function(e){var n=e&&e.__esModule?function(){return e.default}:function(){return e};return t.d(n,"a",n),n},t.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},t.p="",t(t.s=0)}([function(e,t,n){"use strict";function l(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var r=function(){function e(e,t){for(var n=0;n<t.length;n++){var l=t[n];l.enumerable=l.enumerable||!1,l.configurable=!0,"value"in l&&(l.writable=!0),Object.defineProperty(e,l.key,l)}}return function(t,n,l){return n&&e(t.prototype,n),l&&e(t,l),t}}(),s=function(){function e(t){l(this,e),this.option=t;var n={autoplay:!1,skin:"default",mode:"default",volume:50,playlist:null};for(var r in n)t.hasOwnProperty(r)||(t[r]=n[r]);null!=this.option.element?this.init():this.setLog("cPlayer 加载失败，缺少容器参数",1)}return r(e,[{key:"init",value:function(){var e=this,t=this.option.element.id;this.pFirst=!0,this.lyrics=null,this.currTrack=0;var n=this.jsPath()+"skins/"+this.option.skin+"/";this.xhr(n+"template.html").then(function(l){l=l.replace(new RegExp(/{{ ([^"]*) }}/g),t+"$1"),e.option.element.innerHTML=l;for(var r=document.getElementsByTagName("link"),s=!0,a=0;a<r.length;a++){var i=r[a].rel,o=r[a].href;"stylesheet"==i&&o.match(n+"template.css")&&(s=!1)}if(s){var u=document.getElementsByTagName("body")[0],d=document.createElement("link");d.rel="stylesheet",d.href=n+"template.css",u.appendChild(d)}if(e.elements={root:e.option.element,cover_el:document.getElementById(t+"TrackCover"),title_el:document.getElementById(t+"TrackTitle"),artist_el:document.getElementById(t+"TrackArtist"),track_duration_time:document.getElementById(t+"TrackDurationTime"),track_played_time:document.getElementById(t+"TrackPlayedTime"),seek:document.getElementById(t+"Seek"),seek_played:document.getElementById(t+"SeekPlayed"),seek_played_point:document.getElementById(t+"SeekPlayedPoint"),seek_loaded:document.getElementById(t+"SeekLoaded"),toggle_btn_el:document.getElementById(t+"ToggleBtn"),stop_btn_el:document.getElementById(t+"StopBtn"),prev_btn_el:document.getElementById(t+"PrevBtn"),next_btn_el:document.getElementById(t+"NextBtn"),mode_btn_el:document.getElementById(t+"ModeBtn"),mute_btn_el:document.getElementById(t+"MuteBtn"),volume_bar_el:document.getElementById(t+"VolumeBar"),volume_fill_el:document.getElementById(t+"VolumeFill"),lyrics_el:document.getElementById(t+"Lyrics")},e.player=e.createPlayer(),null!=e.elements.toggle_btn_el&&e.elements.toggle_btn_el.addEventListener("click",function(){e.toggle()}),null!=e.elements.stop_btn_el&&e.elements.stop_btn_el.addEventListener("click",function(){e.stop()}),null!=e.elements.prev_btn_el&&e.elements.prev_btn_el.addEventListener("click",function(){e.prev()}),null!=e.elements.next_btn_el&&e.elements.next_btn_el.addEventListener("click",function(){e.next()}),null!=e.elements.mode_btn_el&&(e.addClass(e.elements.mode_btn_el,e.option.mode),e.elements.mode_btn_el.addEventListener("click",function(){e.modeToggle()})),null!=e.elements.seek){var c=function(t){var n=t||window.event,l=0,r=e.getOffset(e.elements.seek,"left"),s=e.elements.seek.clientWidth;l=parseInt(-(r-n.clientX)/s*100),l<0?l=0:l>100&&(l=100),e.updateBar("played",l),e.seek(l),e.elements.track_played_time.innerHTML=e.timeParse(e.player.currentTime)},m=function t(){document.removeEventListener("mousemove",c),document.removeEventListener("mouseup",t),e.playedInterval=setInterval(function(){var t=e.player.currentTime,n=parseInt(e.player.currentTime/e.player.duration*100);null!=e.elements.track_played_time&&(e.elements.track_played_time.innerHTML=e.timeParse(t)),null!=e.elements.seek&&(isNaN(n)?e.updateBar("played",0):e.updateBar("played",n))},100)};e.elements.seek_played_point.addEventListener("mousedown",function(){clearInterval(e.playedInterval),document.addEventListener("mousemove",c),document.addEventListener("mouseup",m)}),e.elements.seek.addEventListener("click",c)}null!=e.elements.volume_bar_el&&e.elements.volume_bar_el.addEventListener("click",function(t){var n=t||window.event,l=0,r=e.getOffset(e.elements.volume_bar_el,"left"),s=e.elements.volume_bar_el.clientWidth;l=parseInt(-(r-n.clientX)/s*100),l<0?l=0:l>100&&(l=100),e.volume(l)}),null!=e.elements.mute_btn_el&&e.elements.mute_btn_el.addEventListener("click",function(){e.mute()}),"random"==e.option.mode&&(e.setRandomList(),e.currTrack=e.shuffleArr[0]),e.option.playlist.length>0&&e.load(e.currTrack)}).catch(function(t){e.setLog("加载失败，HTTP 错误代码: "+t,2)})}},{key:"createPlayer",value:function(){var e=this,t=document.createElement("audio");return t.addEventListener("play",function(){null!=e.elements.toggle_btn_el&&e.addClass(e.elements.toggle_btn_el,"playing")}),t.addEventListener("pause",function(){null!=e.elements.toggle_btn_el&&e.removeClass(e.elements.toggle_btn_el,"playing")}),t.addEventListener("loadstart",function(){null!=e.elements.toggle_btn_el&&e.removeClass(e.elements.toggle_btn_el,"playing"),e.playedInterval=setInterval(function(){var t=e.player.currentTime,n=parseInt(e.player.currentTime/e.player.duration*100);null!=e.elements.track_played_time&&(e.elements.track_played_time.innerHTML=e.timeParse(t)),null!=e.elements.seek&&(isNaN(n)?e.updateBar("played",0):e.updateBar("played",n))},100),e.pFirst&&e.volume(e.option.volume)}),t.addEventListener("loadedmetadata",function(){!e.option.autoplay&&e.pFirst||e.play(),e.pFirst&&(e.pFirst=!1)}),t.addEventListener("progress",function(){var t=e.player.buffered.length?e.player.buffered.end(e.player.buffered.length-1)/e.player.duration*100:0;e.updateBar("loaded",t)}),t.addEventListener("volumechange",function(){e.player.muted?null!=e.elements.mute_btn_el&&e.addClass(e.elements.mute_btn_el,"muted"):null!=e.elements.mute_btn_el&&e.removeClass(e.elements.mute_btn_el,"muted"),null!=e.elements.volume_bar_el&&e.updateBar("volume",100*e.player.volume)}),t.addEventListener("durationchange",function(){null!=e.elements.track_duration_time&&1!=e.player.duration&&(e.elements.track_duration_time.innerHTML=e.timeParse(t.duration))}),t.addEventListener("timeupdate",function(){var n=t.currentTime;if(e.lyrics&&null!=e.elements.lyrics_el){var l="";for(var r in e.lyrics)n>=r&&(l=e.lyrics[r]);e.elements.lyrics_el.innerHTML!=l&&(e.elements.lyrics_el.innerHTML=l,e.elements.lyrics_el.title=l)}}),t.addEventListener("error",function(t){e.setLog("歌曲加载失败，播放器返回错误信息: "+t.path[0].remote.state,3)}),t.addEventListener("ended",function(){e.next()}),t}},{key:"load",value:function(e){var t=this,n=this.option.playlist[e];n?(this.currTrack=e,null!=this.elements.cover_el&&(this.elements.cover_el.src=n.cover),null!=this.elements.title_el&&(this.elements.title_el.innerHTML=n.title,this.elements.title_el.title=n.title),null!=this.elements.artist_el&&(this.elements.artist_el.innerHTML=n.artist,this.elements.artist_el.title=n.artist),this.player.src=n.file,this.lyrics=null,null!=this.elements.lyrics_el&&(this.elements.lyrics_el.innerHTML=""),void 0!=n.lrc&&null!=this.elements.lyrics_el&&this.loadLyrics(n.lrc,function(e){e?t.lyrics=e:t.setLog("歌词加载失败!",3)}),clearInterval(this.playedInterval)):this.setLog("歌曲不存在!",1)}},{key:"loadLyrics",value:function(e,t){var n=this;this.xhr(e).then(function(e){var l=n.lyricsParse(e);t(l)}).catch(function(e){t(!1)})}},{key:"play",value:function(){this.player.play()}},{key:"stop",value:function(){this.player.currentTime=0,this.player.pause(),null!=this.elements.seek&&this.updateBar("played",0),null!=this.elements.track_played_time&&(this.elements.track_played_time.innerHTML=this.timeParse(this.player.currentTime))}},{key:"prev",value:function(){var e=this.currTrack;switch(this.updateBar("played",0),this.pFirst&&(this.pFirst=!1),this.option.mode){case"default":e>0?e--:e=this.option.playlist.length-1;break;case"random":for(var t=0,n=0;n<this.shuffleArr.length;n++)this.currTrack==this.shuffleArr[n]&&(t=n);e=t>0?this.shuffleArr[t-1]:this.shuffleArr[this.shuffleArr.length-1]}this.load(e)}},{key:"next",value:function(){var e=this.currTrack;switch(this.updateBar("played",0),this.pFirst&&(this.pFirst=!1),this.option.mode){case"default":e<this.option.playlist.length-1?e++:e=0;break;case"random":for(var t=0,n=0;n<this.shuffleArr.length;n++)this.currTrack==this.shuffleArr[n]&&(t=n);e=t<this.shuffleArr.length-1?this.shuffleArr[t+1]:this.shuffleArr[0]}this.load(e)}},{key:"modeToggle",value:function(){for(var e=["default","loop","random"],t=0;t<e.length;t++)this.option.mode==e[t]&&null!=this.elements.mode_btn_el&&this.removeClass(this.elements.mode_btn_el,e[t]);"default"==this.option.mode?this.option.mode="loop":"loop"==this.option.mode?(this.option.mode="random",this.setRandomList()):this.option.mode="default",null!=this.elements.mode_btn_el&&this.addClass(this.elements.mode_btn_el,this.option.mode)}},{key:"toggle",value:function(){4==this.player.readyState&&(this.player.paused?this.player.play():this.player.pause())}},{key:"seek",value:function(e){var t=this.player.duration*(e/100);isNaN(t)&&(t=0),this.player.currentTime=t}},{key:"mute",value:function(){this.player.muted?this.player.muted=!1:this.player.muted=!0}},{key:"volume",value:function(e){var t=parseInt(e);this.player.volume=t/100,this.player.volume>0?this.player.muted=!1:this.player.muted=!0}},{key:"push",value:function(e){var t=this;e.forEach(function(e){t.option.playlist.push(e),t.setRandomList()})}},{key:"getCurrInfo",value:function(){return this.option.playlist[this.currTrack]}},{key:"destroy",value:function(){this.stop(),this.option.element.innerHTML="",clearInterval(this.playedInterval);for(var e in this)this.hasOwnProperty(e)&&delete this[e]}},{key:"setRandomList",value:function(){this.shuffleArr=[];for(var e=0;e<this.option.playlist.length;e++)this.shuffleArr.push(e);this.shuffleArr.sort(function(){return.5-Math.random()})}},{key:"updateBar",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"played",t=arguments[1];switch(e){case"played":this.elements.seek_played.style.width=t+"%";break;case"loaded":this.elements.seek_loaded.style.width=t+"%";break;case"volume":this.elements.volume_fill_el.style.width=t+"%"}}},{key:"xhr",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"GET",n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;return new Promise(function(l,r){try{var s=new XMLHttpRequest;s.onreadystatechange=function(){4==s.readyState&&200==s.status?l(s.responseText):4==s.readyState&&r(s.status)},s.open(t,e,!0),s.send(n)}catch(e){}})}},{key:"jsPath",value:function(){for(var e=document.getElementById("cmScript"),t=e.attributes.src.nodeValue.split("/"),n="",l=0;l<t.length-1;l++)n+=t[l]+"/";return n}},{key:"addClass",value:function(e,t){var n="";n="string"==typeof e?document.getElementById(e):e,n.className.indexOf(t)<0&&(n.className+=" "+t)}},{key:"removeClass",value:function(e,t){var n="";if(n="string"==typeof e?document.getElementById(e):e,n.className.indexOf(t)>0){var l=new RegExp("(\\s|^)"+t+"(\\s|$)");n.className=n.className.replace(l,"")}}},{key:"getOffset",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"left",n=0,l=null;switch(t){case"left":n=e.offsetLeft,l=e.offsetParent;break;default:n=e.offsetTop,l=e.offsetParent}for(;null!=l;)n+="left"==t?l.offsetLeft:l.offsetTop,l=l.offsetParent;return n}},{key:"timeParse",value:function(e){var t=0,n=0;return t=parseInt(e/60),n=parseInt(e%60),t<10&&(t="0"+t),n<10&&(n="0"+n),t+":"+n}},{key:"lyricsTimeParse",value:function(e){var t=/(\d+)/g,n=e.match(t),l=0;return l=60*parseInt(n[0]),l+=parseInt(n[1]),l+=.001*parseInt(n[2]),l.toFixed(3)}},{key:"lyricsParse",value:function(e){var t=this,n=/(\r)/g,l=/(\[\d+\:\d+\.\d+])/g,r=e.replace(n,"").split("\n"),s={};return r.forEach(function(e){var n=e.match(l);if(n){var r=e.replace(l,"");n.forEach(function(e){var n=t.lyricsTimeParse(e);s[n]=r})}}),s}},{key:"setLog",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,n=["未知","致命","皮肤","网络"];console.log("["+n[t]+"] "+e)}}]),e}();e.exports=s}])});